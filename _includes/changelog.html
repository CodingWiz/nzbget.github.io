<script src="/js/markdown.min.js"></script>

<script language="javascript">
var ChangeLog = (new function()
{
	'use strict';

	function sort(data)
	{
		data.sort(function(a, b) {
			var an = a.name;
			var bn = b.name;
			if (an.substr(1, 1) === '.') an = '0' + an;
			if (bn.substr(1, 1) === '.') bn = '0' + bn;
			return an < bn ? 1 : -1;
		});
	}

	function buildPage(data, destDiv, withHeaders)
	{
		var MONTH_NAMES = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

		for (var i = 0; i < data.length; i++)
		{
			var rel = data[i];
			if (withHeaders)
			{
				var dat = new Date(rel.created_at);
				var datStr = '' + dat.getDate() + ' ' + MONTH_NAMES[dat.getMonth()] + ' ' + dat.getFullYear();
				$(destDiv).append($('<h2>').text(rel.name).append($('<small>').text(' - ' + datStr)));
			}

			var desc = rel.body;
			desc = desc.replace(/\(https:\/\/github.com\/nzbget\/nzbget\/wiki\/(.+)\)/g,
				function(match, p1) {
					p1 = p1.toLowerCase().replace(/_/g, '-');
					return '(https://nzbget.net/' + p1 + ')';
				});
			desc = markdown.toHTML(desc);
			desc = desc.replace(/\(#([\d]+)/g, '(<a href="https://github.com/nzbget/nzbget/issues/$1">#$1</a>');
			desc = desc.replace(/,\s?#([\d]+)/g, ', <a href="https://github.com/nzbget/nzbget/issues/$1">#$1</a>');

			$(destDiv).append(desc);
		}
	}
	this.buildPage = buildPage;

	function onlyStableReleases(data)
	{
		var newData = [];
		for (var i = 0; i < data.length; i++)
		{
			var rel = data[i];
			if (!rel.prerelease)
			{
				newData.push(rel);
			}
		}
		return newData;
	}

	function onlyTestingReleasesSinceLatestStabe(data)
	{
		var stableVersion = '{{site.data.version.stable-version}}';
		var testingVersion = '{{site.data.version.testing-version}}';
		if (stableVersion >= testingVersion)
		{
			return [];
		}

		var newData = [];
		for (var i = 0; i < data.length; i++)
		{
			var rel = data[i];
			if (rel.prerelease && rel.name.indexOf(testingVersion) === 0)
			{
				newData.push(rel);
			}
		}
		return newData;
	}

	function loaded(data, which)
	{
		if (which === 'stable')
		{
			data = onlyStableReleases(data);
		}
    	else if (which === 'testing')
		{
			data = onlyTestingReleasesSinceLatestStabe(data);
		}

		sort(data);
		buildPage(data, '#hist-content', true);
		$('#hist-loading').hide();
		$('#hist-content').removeClass('hide');
	}

	function load(url, callback) {
		$.ajax({
			url: url,
			complete: function(xhr) {
				callback.call(null, xhr.responseJSON);
			}
		});
	}
	this.load = load;

{% if true %}
	// production version (fetches log from GitHub)
	this.loadAndBuildPage = function(which, callback) {
		load('https://api.github.com/repos/nzbget/nzbget/releases',
			function(data) {
				load('https://api.github.com/repos/nzbget/nzbget/releases?page=2',
				function(data2) {
					Array.prototype.push.apply(data, data2);
					loaded(data, which);
					if (callback) callback();
				}
			)
		});
	}
{% else %}
	// development version (predefined log entries)
	this.loadAndBuildPage = function(which, callback) {
		var data = [
			{name: '19.0-testing-r1991', created_at: '2017-05-13T12:27:26Z', prerelease: true, body: '- unpack during downloading (#371);\n- renaming of obfuscated file names during downloading (#360).'},
			{name: '18.1', created_at: '2017-05-27T11:28:07Z', body: '- fixed: crash during download, caused by a race condition (#356);\n- fixed: sleep mode did not work on Windows (#350).'},
			{name: '19.0-testing-r1929', created_at: '2017-04-01T12:27:26Z', prerelease: true, body: '- extensions scripts can now be executed from settings page (#50);\n- added support for ECC certificates in built-in web-server (#353).'},
			{name: '18.0', created_at: '2017-02-08T16:59:17Z', body: '- don&#39;t many nice new features.'},
			{name: '18.0-testing-r1826', created_at: '2017-01-14T12:27:26Z', prerelease: true, body: '- fixed one bug;\n-fixed another bug.'},
			{name: '0.3.0', created_at: '2007-11-10T12:27:26Z', body: '- a lot of new features;\n - see [Keyboard shortcuts](https://github.com/nzbget/nzbget/wiki/Keyboard-shortcuts);\n - see [Keyboard shortcuts](https://github.com/nzbget/nzbget/wiki/Keyboard-shortcuts);'},
			{name: '0.3.1', created_at: '2007-12-18T12:27:26Z', body: '- a lot of new features.'},
			{name: '17.1', created_at: '2016-09-02T12:27:26Z', body: '- many new features.'},
			{name: '9.0', created_at: '2015-06-02T12:27:26Z', body: '- many new features.'}];
		loaded(data, which);
		if (callback) callback();
	}
{% endif %}
}());
</script>
